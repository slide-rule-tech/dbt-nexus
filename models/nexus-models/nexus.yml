version: 2

models:
  # Event Log Models
  - name: nexus_events
    description:
      "Unified events table containing all events from enabled sources"
    tests:
      - unique:
          column_name: event_id
          config:
            severity: error
    columns:
      - name: event_id
        description: "Unique identifier for the event"
        tests:
          - not_null:
              config:
                severity: error
          - dbt_utils.expression_is_true:
              expression: "like 'evt_%'"
              config:
                severity: warn
      - name: occurred_at
        description: "Timestamp when the event occurred"
        tests:
          - not_null:
              config:
                severity: error
      - name: _ingested_at
        description: "When the data was synced to the data warehouse"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _processed_at
        description: "When the data was last run or built by dbt"
        tests:
          - not_null:
              config:
                severity: warn

  - name: nexus_entity_identifiers
    description:
      "Unified entity identifiers table containing all person and group
      identifiers from enabled sources"
    columns:
      - name: entity_identifier_id
        description: "Unique identifier for the entity identifier record"
        tests:
          - not_null
          - unique
      - name: entity_type
        description: "Type of entity (person, group, or custom types)"
        tests:
          - not_null
          - accepted_values:
              values: ["person", "group"]
      - name: identifier_type
        description:
          "Type of identifier (email, phone, domain, notion_id, etc.)"
      - name: identifier_value
        description: "The actual identifier value"
      - name: normalized_value
        description:
          "Normalized version of identifier_value (lowercase emails, digits-only
          phone, etc.)"
      - name: role
        description:
          "Role associated with this identifier (contact, assignee,
          organization, etc.)"

  - name: nexus_entity_traits
    description:
      "Unified entity traits table containing all person and group traits from
      enabled sources"
    columns:
      - name: entity_trait_id
        description: "Unique identifier for the entity trait record"
        tests:
          - not_null
          - unique
      - name: entity_type
        description: "Type of entity (person, group, or custom types)"
        tests:
          - not_null
          - accepted_values:
              values: ["person", "group"]
      - name: trait_name
        description: "Name of the trait (name, email, company_name, etc.)"
      - name: trait_value
        description: "Value of the trait"

  - name: nexus_relationship_declarations
    description:
      "Unified relationship declarations containing all entity relationships
      from enabled sources"
    columns:
      - name: relationship_declaration_id
        description: "Unique identifier for the relationship declaration"
        tests:
          - not_null
          - unique
      - name: entity_a_identifier
        description: "Identifier value for entity A"
      - name: entity_a_identifier_type
        description: "Identifier type for entity A"
      - name: entity_a_type
        description: "Entity type for entity A (person, group, etc.)"
      - name: entity_a_role
        description: "Role of entity A in the relationship"
      - name: entity_b_identifier
        description: "Identifier value for entity B"
      - name: entity_b_identifier_type
        description: "Identifier type for entity B"
      - name: entity_b_type
        description: "Entity type for entity B (person, group, etc.)"
      - name: entity_b_role
        description: "Role of entity B in the relationship"
      - name: relationship_type
        description: "Type of relationship (membership, etc.)"
      - name: relationship_direction
        description: "Direction of relationship (bidirectional, a_to_b, b_to_a)"
      - name: is_active
        description: "Whether the relationship is currently active"

  # Identity Resolution Models
  - name: nexus_entity_identifiers_edges
    description:
      "Unified edges table for entity identity resolution - connects identifiers
      that appear together"
    columns:
      - name: edge_id
        description: "Identifier for the event that created this edge"
      - name: entity_type_a
        description: "Entity type for identifier A"
      - name: identifier_type_a
        description: "Type of the first identifier in the edge"
      - name: identifier_value_a
        description: "Value of the first identifier in the edge"
      - name: entity_type_b
        description: "Entity type for identifier B"
      - name: identifier_type_b
        description: "Type of the second identifier in the edge"
      - name: identifier_value_b
        description: "Value of the second identifier in the edge"

  - name: nexus_resolved_person_identifiers
    description:
      "Resolved person identifiers with assigned person_id after entity
      resolution"
    columns:
      - name: person_identifier_id
        description: "Unique identifier for the resolved person identifier"
        tests:
          - not_null
          - unique
      - name: person_id
        description: "Resolved person entity ID"
        tests:
          - not_null
      - name: identifier_type
        description: "Type of identifier"
      - name: identifier_value
        description: "Identifier value"

  - name: nexus_resolved_group_identifiers
    description:
      "Resolved group identifiers with assigned group_id after entity resolution"
    columns:
      - name: group_identifier_id
        description: "Unique identifier for the resolved group identifier"
        tests:
          - not_null
          - unique
      - name: group_id
        description: "Resolved group entity ID"
        tests:
          - not_null
      - name: identifier_type
        description: "Type of identifier"
      - name: identifier_value
        description: "Identifier value"

  - name: nexus_resolved_entity_traits
    description:
      "Unified resolved entity traits table - unions person and group resolved
      traits"
    columns:
      - name: entity_id
        description: "Resolved entity ID (person_id or group_id)"
      - name: entity_type
        description: "Type of entity (person or group)"
      - name: trait_name
        description: "Name of the trait"
      - name: trait_value
        description: "Latest value of the trait"
      - name: occurred_at
        description: "Timestamp when this trait value was observed"

  - name: nexus_resolved_relationship_declarations
    description:
      "Resolved relationship declarations with entity IDs after entity
      resolution"
    columns:
      - name: relationship_declaration_id
        description: "Unique identifier for the relationship declaration"
      - name: entity_a_id
        description: "Resolved entity ID for entity A"
      - name: entity_a_type
        description: "Entity type for entity A"
      - name: entity_a_role
        description: "Role of entity A in the relationship"
      - name: entity_b_id
        description: "Resolved entity ID for entity B"
      - name: entity_b_type
        description: "Entity type for entity B"
      - name: entity_b_role
        description: "Role of entity B in the relationship"
      - name: relationship_type
        description: "Type of relationship"
      - name: relationship_direction
        description: "Direction of relationship"
      - name: is_active
        description: "Whether the relationship is currently active"

  # Final Tables
  - name: nexus_entities
    description:
      "Final unified entities table containing all resolved persons and groups
      with pivoted traits"
    tests:
      - unique:
          column_name: entity_id
          config:
            severity: error
    columns:
      - name: entity_id
        description: "Unique entity identifier (person_id or group_id)"
        tests:
          - not_null:
              config:
                severity: error
      - name: entity_type
        description: "Type of entity (person, group, or custom types)"
        tests:
          - not_null
          - accepted_values:
              values: ["person", "group"]
      - name: name
        description: "Name of the entity"
      - name: email
        description: "Email address (for persons)"
      - name: company_name
        description: "Company name (for groups)"
      - name: domain
        description: "Domain (for groups)"
      - name: notion_id
        description: "Notion page ID"
      - name: _processed_at
        description: "When the data was last run or built by dbt"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _updated_at
        description: "When the data was last updated (max of trait occurred_at)"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _created_at
        description: "When the entity was first created (min of identifier occurred_at)"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _last_merged_at
        description: "When entity identifiers were last merged (max of edge timestamps)"
        tests:
          - not_null:
              config:
                severity: warn
      - name: last_interaction_at
        description: "Most recent event timestamp for this entity"
        tests:
          - not_null:
              config:
                severity: warn
      - name: first_interaction_at
        description: "First event timestamp for this entity"
        tests:
          - not_null:
              config:
                severity: warn

  - name: nexus_relationships
    description:
      "Final relationships table containing all resolved entity relationships"
    tests:
      - unique:
          column_name: relationship_id
          config:
            severity: error
    columns:
      - name: relationship_id
        description: "Unique relationship identifier"
        tests:
          - not_null:
              config:
                severity: error
      - name: entity_a_id
        description: "Entity ID of entity A in the relationship"
        tests:
          - not_null
      - name: entity_a_type
        description: "Entity type of entity A"
      - name: entity_a_role
        description: "Role of entity A in the relationship"
      - name: entity_b_id
        description: "Entity ID of entity B in the relationship"
        tests:
          - not_null
      - name: entity_b_type
        description: "Entity type of entity B"
      - name: entity_b_role
        description: "Role of entity B in the relationship"
      - name: relationship_type
        description: "Type of relationship (membership, etc.)"
      - name: relationship_direction
        description: "Direction of relationship (bidirectional, a_to_b, b_to_a)"
      - name: is_active
        description: "Whether the relationship is currently active"
      - name: established_at
        description: "When the relationship was first established"
      - name: last_updated_at
        description: "When the relationship was last updated"
      - name: primary_source
        description: "Primary source system for this relationship"
      - name: _processed_at
        description: "When the data was last run or built by dbt"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _updated_at
        description: "When the relationship was last updated (max of declaration occurred_at)"
        tests:
          - not_null:
              config:
                severity: warn
      - name: _created_at
        description: "When the relationship was first created (min of declaration occurred_at)"
        tests:
          - not_null:
              config:
                severity: warn

  # State Models
  - name: nexus_states
    description: "States table for tracking entity state changes"
    tests:
      - unique:
          column_name: state_id
          config:
            severity: error
    columns:
      - name: state_id
        description: "Unique identifier for the state record"
        tests:
          - not_null:
              config:
                severity: error
          - dbt_utils.expression_is_true:
              expression: "like 'st_%'"
              config:
                severity: warn
